<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falconstead</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Suppressing the favicon error -->
    <link rel="icon" href="data:image/x-icon;base64,AAABAAEAEBAQAAA..." />

</head>

<script src="./websocket_client/js/htx_okx_spread_order.js"></script>
<link href="./websocket_client/css/statusbadge.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" href="websocket_client/css/arbButton.css">
<link rel="stylesheet" href="websocket_client/css/util.css">
<link rel="stylesheet" href="websocket_client/css/algoTable.css">
<!-- <link rel="stylesheet" href="websocket_client/css/fonts.css"> -->

<!-- sorting table -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>


<body class="container-fluid">
    
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Falconstead </a>  
            <a >Welcome <tag id ="username_intro"></tag></a>
            <script> document.getElementById('username_intro').innerHTML = localStorage.getItem('username')</script>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto" id="navbar-links">
                    <!-- Login Link (Visible when logged out) -->
                    <li class="nav-item" id="login-link">
                        <a class="nav-link" href="auth.html">Login</a>
                    </li>

          
                    <!-- Logout Link (Visible when logged in) -->
                    <li class="nav-item" id="logout-link" style="display: none;">
                        <a class="nav-link logout-btn" href="#" onclick="logout()">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- WARNING ALERT -->
    <div class="container mt-3">
        <div id="alertBox" class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong id="alertMessage">‚ö†Ô∏è Warning!</strong> Something needs your attention.
            <button type="button" class="btn btn-danger btn-sm ms-3" onclick="stopTwilioCall()">Stop Call</button>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>

    <div class = "row">

        <!-- DISPLAY TABLE -->
        <div class="col-lg-6 container-fluid mt-4" id="orderbookdisplayContainer">
  
            <!-- Container for the funding rates row -->
            <div class="row">
                 <!--WS STATUS BADGE  -->
            
                <!-- OKX Section -->
                <div class="col-md-4 mb-4">
                    <h6>Connection Status:</h6>
                    <div class="d-flex flex-wrap">
                        <span id="status-okx" class="statusbadge bg-danger me-2 mb-2">okx: dead</span>
                        <span id="status-htx" class="statusbadge bg-danger me-2 mb-2">htx: dead</span>
                        <span id="status-bnb" class="statusbadge bg-danger mb-2">bnb: dead</span>
                    </div>
                </div>
                
                <div id="okx-section" class="col-md-4 mb-4">
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="text-dark mb-0">OKX</h6>
                        <span id="fundingratets_okx" class="text-warning text-end">-</span>
                    </div>
                    <div class="">
                        <!-- <div class="d-flex justify-content-between">
                                <span id="funding-time-okx" class="text-primary text-end hover-info">--</span>
                                
                                <span id="next-funding-time-okx" class="text-primary text-end hover-info">--</span>
                        </div> -->
                        
                        <div class="d-flex justify-content-between">
                            <!-- <span class="text-muted">Currency:</span> -->
                            <span id="currency-okx" class="text-primary text-end">--</span>
                            <!-- <span class="text-muted">Funding Rate:</span> -->
                            <span id="funding-rate-okx" class="text-primary text-end">--</span>
                    
                        </div>
                    </div>
                </div>
            
                <!-- HTX Section -->
                <div id="htx-section" class="col-md-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="text-dark mb-0">HTX</h6>
                        <span id="fundingratets-htx" class="text-warning text-end">-</span>
                    </div>
                    <div class="">
                        <!-- <div class="d-flex justify-content-between">
                            <span class="text-muted">Funding Time:</span>
                            <span id="funding-time-htx" class="text-primary text-end">--</span>
                            <span class="text-muted">Next Funding Time:</span>
                            <span id="next-funding-time-htx" class="text-primary text-end">--</span>
                        </div> -->
                        <div class="d-flex justify-content-between">
                             <!-- <span class="text-muted">Currency:</span> -->
                             <span id="currency-htx" class="text-primary text-end">--</span>
                            <!-- <span class="text-muted">Funding Rate:</span> -->
                            <span id="funding-rate-htx" class="text-primary text-end">--</span>
                           
                        </div>
                    </div>
                </div>
            </div>
            
            
            
            
            <!-- ORDERBOOK DISPLAY -->
            <div class="justify-content-between align-items-center mb-3">
                    <!-- CHOICES FOR LEADING AND LAGGING EXCHANGES -->
                    <div class="row">
                          
                        <div class="container">
                            <div class="row align-items-center">
                              <!-- Currency Input -->
                              <div class="col-md-4 col-sm-12 mb-3">
                                <div class="input-group">
                                  <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                                  <select id="currency-input" class="form-select" aria-label="Currency" onchange="updateCurrency()">
                                    <option value="">Select Currency</option>
                                    <option value="BTC-USDC">BTC-USDC</option>
                                    <option value="BTC-USD-SWAP" selected>BTC-USD-SWAP</option>
                                    <option value="BTC-USDT-SWAP">BTC-USDT-SWAP</option>
                                  </select>
                                </div>
                              </div>
                          
                              <!-- Exchange 1 Dropdown -->
                              <div class="col-md-4 col-sm-12 mb-3">
                                <div class="input-group">
                                  <span class="input-group-text"><i class="bi bi-gear"></i></span>
                                  <select id="exchange1-input" class="form-select" aria-label="Exchange 1" onchange="updateExchange()">
                                    <option value="">Select Exchange 1</option>
                                    <option value="okx" selected>OKX</option>
                                    <option value="htx">HTX</option>
                                  </select>
                                </div>
                              </div>
                          
                              <!-- Exchange 2 Dropdown -->
                              <div class="col-md-4 col-sm-12 mb-3">
                                <div class="input-group">
                                  <span class="input-group-text"><i class="bi bi-gear"></i></span>
                                  <select id="exchange2-input" class="form-select" aria-label="Exchange 2" onchange="updateExchange()">
                                    <option value="">Select Exchange 2</option>
                                    <option value="okx" >OKX</option>
                                    <option value="htx" selected>HTX</option>
                                  </select>
                                </div>
                              </div>
                            </div>
                          </div>

                    </div>

                    <!-- ORDERBOOK AND LAST TRADE SCROLLABLE TABLES -->
                    <div class="row">
                       
                        <div class="container pb-4">
                            <div class="row ">
                                <!-- First Exchange Last Prices -->
                                <div class="col-md-3">
                                    <div class="card shadow-sm">
                                        <div class="card-body py-0 my-0">
                                        <h5 class="text-center border-bottom  mb-3">Last Trades</h5>
                                        
                                        <!-- Row for Exchange and Currency -->
                                        <div class="d-flex justify-content-between">
                                            <p class="mb-0"><strong>Exchange:</strong> <span id="selected-exchange-lastprice-1" class="text-danger">Not Selected</span></p>
                                            <p class="mb-0"><strong>Currency:</strong> <span id="selected-ccy-lastprice-1" class="text-danger">Not Selected</span></p>
                                        </div>
                                    
                                        
                                        </div>
                                        <div class="orderbook-scroll-container scrollable-lastprice">
                                            <table class="orderBookTable">
                                            <thead>
                                                <tr>
                                                <th style='position: sticky; top: -1px;background: grey'>Ts</th>
                                                <th style='position: sticky; top: -1px;background: grey'>Price(USD)</th>
                                                <th style='position: sticky; top: -1px;background: grey'>Direction</th>
                                                </tr>
                                            </thead>
                                            <tbody id="lastprice-data-table-body-1">
                                                <!-- Last price data will be dynamically inserted here -->
                                            </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    </div>
                            
                                <!-- leading Order Book Section -->
                                <div class="col-md-3" >
                                    <div class="orderbook-section">
                                    <!-- <h4>Order Book 1</h4>
                                    <div id="selected-info">
                                        <p>Exchange: <span id="selected-exchange-orderbook-1">Not Selected</span></p>
                                        <p>Currency: <span id="selected-ccy-orderbook-1">Not Selected</span></p>
                                    </div>
                                    <p id="orderbook-timestamp-1">Timestamp: Not Available</p> -->

                                    <div class="container p-0">
                                        <div class="card shadow-sm ">
                                        <div class="card-body py-0 my-0">
                                            <h5 class="text-center border-bottom  mb-3">Order Book 1</h5>
                                            
                                            <div class="d-flex justify-content-between">
                                                <p class="mb-0"><span id="selected-exchange-orderbook-1" class="text-danger">Exchange</span></p>
                                                <p class="mb-0"><span id="selected-ccy-orderbook-1" class="text-danger">Currency</span></p>
                                            </div>
                                            <tag id="orderbook-timestamp-1" class="text-center text-muted m-0">
                                                <strong></strong> <span>Not Available</span>
                                            </tag>
                                            
                                        </div>
                                        </div>
                                        <div class="orderbook-scroll-container scrollable-orderbook">
                                            <table class="orderBookTable " id="orderBookTable1">
                
                                            <thead>
                                                <tr>
                                                <th style='position: sticky; top: -1px;background: grey'>Price</th>
                                                <th style='position: sticky; top: -1px;background: grey'>Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody id="order-data-table-body-1">
                                                <!-- Order book data will be dynamically inserted here -->
                                            </tbody>
                                            </table>
                                        </div>

                                    </div>
                                    
                                    </div>
                                </div>

                                <!-- lagging Order Book Section -->
                                <div class="col-md-3" >
                                    <div class="orderbook-section ">
                     

                                    <div class="container p-0">
                                        <div class="card shadow-sm ">
                                        <div class="card-body py-0 my-0">
                                            <h5 class="text-center border-bottom  mb-3">Order Book 2</h5>
                                            
                                            <!-- Row for Exchange and Currency -->
                                            <div class="d-flex justify-content-between">
                                                <p class="mb-0"><strong></strong> <span id="selected-exchange-orderbook-2" class="text-danger">Not Selected</span></p>
                                                <p class="mb-0"><strong></strong> <span id="selected-ccy-orderbook-2" class="text-danger">Not Selected</span></p>
                                            </div>
                                    
                                            <!-- Timestamp -->
                                            <tag id="orderbook-timestamp-2" class="text-center text-muted m-0">
                                                <strong></strong> <span>Not Available</span>
                                            </tag>
                                        </div>
                                        </div>
                                        
                                        <div class="orderbook-scroll-container scrollable-orderbook">
                                            <table class="orderBookTable " id="orderBookTable1">
                
                                            <thead>
                                                <tr>
                                                <th style='position: sticky; top: -1px;background: grey'>Price</th>
                                                <th style='position: sticky; top: -1px;background: grey'>Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody id="order-data-table-body-2">
                                                <!-- Order book data will be dynamically inserted here -->
                                            </tbody>
                                            </table>
                                        </div>

                                    </div>

                                    

                                    </div>
                                </div>

                                    <!-- Second Exchange Last Prices -->
                                <div class="col-md-3">
                                    <div class="orderbook-section">
                                    

                                    <div class="card shadow-sm ">
                                        <div class="card-body py-0 my-0">
                                        <h5 class="text-center border-bottom  mb-3">Last Trades</h5>
                                        
                                        <!-- Row for Exchange and Currency -->
                                        <div class="d-flex justify-content-between">
                                            <p class="mb-0"><strong>Exchange:</strong> <span id="selected-exchange-lastprice-2" class="text-danger">Not Selected</span></p>
                                            <p class="mb-0"><strong>Currency:</strong> <span id="selected-ccy-lastprice-2" class="text-danger">Not Selected</span></p>
                                        </div>
                                    
                                    
                                        </div>
                                        <div class="orderbook-scroll-container scrollable-lastprice">
                                            <table class="orderBookTable">
                                            <thead>
                                                <tr>
                                                <th style='position: sticky; top: -1px;background: grey'>Ts</th>
                                                <th style='position: sticky; top: -1px;background: grey'>Price(USD)</th>
                                                <th style='position: sticky; top: -1px;background: grey'>Direction</th>
                                                </tr>
                                            </thead>
                                            <tbody id="lastprice-data-table-body-2">
                                                <!-- Last price data will be dynamically inserted here -->
                                            </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                                
                    <!-- BUTTONS FOR COMPARING -->
                    <div class="row">
                        <div id="securedContentBidAskOrder" class="alert alert-success" style="display: none;">
                            <!-- Sync and Reset Buttons (Always at the Bottom) -->
                            <div class="rfs-spread-base-cell p-0">
                                <!-- Header with Bid, Spread, and Ask -->
                                <div class="RfsSpreadCell_rfs-spread-card-header-container d-flex justify-content-center">
                                    <!-- <span class="quote-side-text text-success fw-bold">Bid</span> -->
                                    <div class="quote-bps-container d-flex align-items-center ">
                                        <span class="quote-bps-value fw-bold" id="buysellgapPx">-</span>&nbsp;
                                        <span class="quote-bps-unit text-muted">BPS</span>
                                    </div>
                                    <!-- <span class="quote-side-text text-danger fw-bold">Ask</span> -->
                                </div>
                                   
    
                                <!-- Card Section for Bid and Ask Prices -->
                                <div class="RfsSpreadCell_rfs-spread-base-cell-prices d-flex justify-content-center">
                                    <!-- Bid Card -->
                                    <span class="quote-side-text text-success fw-bold">Bid</span>
                                    <div class="quote-price-card buy card p-3 text-center" onclick="handleClick('buy')" role="button" tabindex="0">
                                        <!-- <div class="card-upper-container">
                                            <div class="best-quote-size text-muted">50K USD</div>
                                        </div> -->
                                        <div class="best-quote-price-container">
                                            <div class="price-data fs-4 fw-bold" id="buySpread">-</div>
                                        </div>
                                        <div class="card-bottom-container" >
                                            <div class="card-bottom-quote-diff text-success" id="buySpreadSz">-</div>
                                        </div>
                                    </div>
                            
                                    <!-- Ask Card -->
                                    <div class="quote-price-card sell card p-3 text-center border-danger" onclick="handleClick('sell')" role="button" tabindex="0">
                                        <!-- <div class="card-upper-container">
                                            <div class="best-quote-size text-muted">50K USD</div>
                                        </div> -->
    
                                        <div class="best-quote-price-container">
                                            <div class="price-data fs-4 fw-bold" id="sellSpread">-</div>
                                        </div>
                                        <div class="card-bottom-container">
                                            <div class="card-bottom-quote-diff text-danger" id="sellSpreadSz">-</div>
                                        </div>
                                    </div>
                                    <span class="quote-side-text text-danger fw-bold">Ask</span>
    
                                </div>
                            </div>
                        
                        </div>
                    </div>
                    
                </div>
                  
            
        </div>

        <!-- FORM for ordering -->
        <div class="col-lg-6 container-fluid  mt-4">
            <!-- This section will only be visible if the JWT is present -->
            <div id="securedContent" class="alert alert-success" style="display: none;">
                    
                <h4>Welcome, you have access to secured content!</h4>
                <p>This section is protected by JWT. You are logged in.</p>

                <!-- Notification Hub Icon and Dropdown -->
                <div class="position-relative text-end ">
                    <button id="notification-icon" class="btn btn-light" onclick="toggleNotificationHub()">
                        üõé Notifications <span id="notification-count" class="badge bg-danger">0</span>
                    </button>
                    <div id="notification-hub" class="notification-hub bg-light shadow rounded" style="display: none;">
                        <h5 class="p-2">Notifications</h5>
                        <div id="toast-list" class="toast-list p-2" style="max-height: 300px; overflow-y: auto;">
                            <!-- Dynamic Toast Messages Will Appear Here -->
                        </div>
                        
                        <button class="btn btn-secondary w-100" onclick="clearNotifications()">Clear All</button>
                    </div>
                </div>

                <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                      <button class="nav-link active" id="pills-manual-order-tab" data-bs-toggle="pill" data-bs-target="#pills-manual-order" type="button" role="tab" aria-controls="pills-manual-order" aria-selected="true">Manual Order</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="pills-algo-order-tab" data-bs-toggle="pill" data-bs-target="#pills-algo-order" type="button" role="tab" aria-controls="pills-algo-order" aria-selected="false">Algo Order</button>
                    </li>
                </ul>

                
                <div class="tab-content" id="pills-tabContent">
                    <div class="tab-pane fade show active" id="pills-manual-order" role="tabpanel" aria-labelledby="pills-manual-order-tab">
                        <!-- User Input Section -->
                        <div class="card p-3 ">
                            <form id="order-form">
                                <form id="order-form">
                                    <div class="row g-2">
                                    
                                        <div class="col-12 col-md-6 mb-3">
                                            <label for="leading-exchange-input" class="form-label">
                                                Leading
                                                <!-- Tooltip Icon -->
                                                <span class="tooltip-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Your order applies to this exchange">
                                                <i class="bi bi-info-circle"></i>
                                                </span>
                                            </label>
                                            
                                            <select id="leading-exchange-input" class="form-select" required>
                                                <option value="" disabled selected>Select Exchange</option>
                                                <option value="none">NA</option>
                                                <option value="htx">HTX</option>
                                                <option value="okx" selected>OKX</option>
                                            </select>
                                        </div>
                                
                                        <div class="col-12 col-md-6 mb-3">
                                            <label for="lagging-exchange-input" class="form-label">Lagging:</label>
                                            <select id="lagging-exchange-input" class="form-select" required>
                                                <option value="" disabled selected>Select Exchange</option>
                                                <option value="none">NA</option>
                                                <option value="htx" selected>HTX</option>
                                                <option value="okx">OKX</option>
                                            </select>
                                        </div>
                                
                                        <!-- Instrument Field for Spot/Swap -->
                                        <div class="col-12 col-md-6 mb-3">
                                            <label for="instrument-input" class="form-label">Instrument:</label>
                                            <select id="instrument-input" class="form-select" required onchange="updateCurrencyOptionsGeneral('instrument-input','manual-order-form-currency-input','contract-type-container')">
                                                <option value="" disabled selected>Select Instrument</option>
                                                <option value="spot">Spot</option>
                                                <option value="swap" selected>Swap</option>
                                                <option value="futures" >Futures</option>

                                            </select>
                                        </div>
                                     
                                
                                        <!-- Order Type Tabs -->
                                        <div class="col-12 col-md-6 mb-3">
                                            <label for="order-type-input" class="form-label">Order Type:</label>
                                            <select id="order-type-input" class="form-select" required onchange="handleOrderTypeChange()">
                                                <option value="" disabled selected>Select Order Type</option>
                                                <option value="market" >Market</option>
                                                <option value="limit" selected>Limit</option>
                                                <option value="algo">Algo</option>

                                            </select>
                                        </div>
                                
                                        <div class="col-12 col-md-6 mb-3">
                                            <label for="manual-order-form-currency-input" class="form-label">Currency Pair:</label>
                                            <select id="manual-order-form-currency-input" class="form-select" required>
                                                <option value="">Select Currency Pair</option>
                                                <option value="BTC-USD-SWAP">BTC-USD-SWAP</option>
                                            </select>
                                        </div>
                                
                                         <!-- Contract Type Field (Initially Hidden) -->
                                        <div class="col-12 col-md-6 mb-3" id="contract-type-container" style="display: none;">
                                            <label for="contract-type-input" class="form-label">Contract Type:</label>
                                            <select id="contract-type-input" class="form-select">
                                                <option value="" disabled selected>Select Contract Type</option>
                                                <option value="this_week">This Week</option>
                                                <option value="next_week">Next Week</option>
                                                <option value="quarter">Quarter</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Price field (two inputs side by side for Price 1 and Price 2) -->
                                        <div class="col-12 col-md-12 mb-3" id="price-container">
                                            <div class="row">
                                                <div class="col-6" id="form-container-price1-input">
                                                    <label for="price-input-1" class="form-label">Price 1:</label>
                                                    <input type="number" id="price-input-1" class="form-control" placeholder="Price" required>
                                                </div>
                                                <div class="col-6" id="form-container-price2-input">
                                                    <label for="price-input-2" class="form-label">Price 2:</label>
                                                    <input type="number" id="price-input-2" class="form-control" placeholder="Price" required>
                                                </div>
                                            </div>
                                        </div>
                                
                                        <!-- Spread field -->
                                        <div class="col-12 col-md-6 mb-3" id="spread-container">
                                            <label for="spread-input" class="form-label">Spread:</label>
                                            <input type="number" id="spread-input" class="form-control" placeholder="Spread">
                                        </div>
                                
                                        <div class="col-12 col-md-6 mb-3">
                                            <label for="qty-input" class="form-label">Quantity:</label>
                                            <input type="number" id="qty-input" class="form-control" placeholder="Quantity" value="1" required>
                                        </div>
                                        
                                        
                                    

                                    </div>

                                    <div id="form-buy-sell-container">
                                        <div class="d-flex justify-content-between mt-3" >
                                            <button type="submit" id="buy-button" value="buy" class="btn btn-success w-100 me-1">Buy</button>
                                            <button type="submit" id="sell-button" value="sell" class="btn btn-danger w-100 ms-1">Sell</button>
                                        </div>
                                    </div>
                                
                                </form>
                                
                                
                                <script>
                                    function handleOrderTypeChange() {

                                        const orderType = document.getElementById('order-type-input').value;
                                        const priceContainer = document.getElementById('price-container');
                                        const spreadContainer = document.getElementById('spread-container');
                                        const priceInputs = priceContainer.querySelectorAll('input');
                                        const formBuySellContainer = document.getElementById('form-buy-sell-container');

                                        // Show or hide fields based on selected order type
                                        if (orderType === 'market') {
                                            priceContainer.style.display = 'none';
                                            spreadContainer.style.display = 'none';
                                            formBuySellContainer.style.display = 'block';
                                            priceInputs.forEach(input => input.removeAttribute('required'));

                                        } else if (orderType === 'limit') {
                                            priceContainer.style.display = 'block';
                                            spreadContainer.style.display = 'none';
                                            formBuySellContainer.style.display = 'block';

                                        } else if (orderType === 'algo') {
                                            formBuySellContainer.style.display = 'none';
                                            priceContainer.style.display = 'block';
                                            spreadContainer.style.display = 'block';

                                        
                                        } else {
                                            formBuySellContainer.style.display = 'block';
                                            priceContainer.style.display = 'none';
                                            spreadContainer.style.display = 'none';
                                        }
                                    }

                                    document.querySelectorAll('.form-check-input').forEach(toggle => {
                                        toggle.addEventListener('change', (event) => {
                                            const isChecked = event.target.checked;
                                            console.log(`${event.target.id} is now ${isChecked ? 'ON' : 'OFF'}`);
                                        });
                                    });

                                
                                    // Initialize form on page load
                                    document.addEventListener('DOMContentLoaded', handleOrderTypeChange);
                                </script>

                            </form>
                        </div>
                    </div>

                    <div class="tab-pane fade " id="pills-algo-order" role="tabpanel" aria-labelledby="pills-algo-order-tab">
                        <div>
                            <!-- Algo Strats Table -->
                            <!-- Algo List Table -->
                        <div class="scrollable-table" >
                            <table class="table" >
                                <thead>
                                    <tr style="position: sticky; top: 0; z-index: 1020; font-size: small;">
                                        <th>Algo Name</th>
                                        <th>Lead | Lag</th>
                                        <th>Spread | Qty</th>
                                        <th>Currency</th>
                                        <th>Instrument | Contract</th>
                                        <!-- <th>Trade Direction</th> -->
                                        <th>Status</th>
                                        <th>On / Off</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                        
                                    <tbody id="algo-list">
                                        <!-- Dynamically added rows will appear here -->
                                    </tbody>
                                    <tbody id="algo-list-new">
                                        <!-- Dynamically added rows will appear here -->
                                    </tbody>
                            </table>
                        </div>

                        <!-- Button to Open Modal -->
                        <button class="btn btn-primary mt-3" onclick="openAlgoModal()">Add New Algo</button>

                        <!-- Modal for Adding/Editing Algo -->
                        <div class="modal" id="algoModal" tabindex="-1">
                            
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">

                                    <div class="modal-header">
                                        <h5 class="modal-title">Add New Algo</h5>
                                        <button type="button" class="btn-close" onclick="closeAlgoModal()"></button>
                                    </div>
                                    
                                    <div class="modal-body">
                                        <form id="new-algoForm">
                                            <!-- Algo Type and Algo name -->
                                            <div class="row">
                                                <div class="input-group mb-3">
                                                    <!-- Input Field -->
                                                    <div class="input-group-prepend">
                                                        <select class="form-select" id="new-algo-type" onchange="setnewAlgoType(this)" required>
                                                            <option value="" disabled >Select Algo Type</option>
                                                            <option value="diaoyu" selected>Diaoyu</option>
                                                            <option value="diaoxia" >Diaoxia</option>
                                                            <!-- Additional options can be added here -->
                                                        </select>
                                                    </div>
                                                    <input type="text" class="form-control" id="new-algo-name" placeholder="Type algo name" >
                                                </div>
                                            </div>
                                            

                                            <!-- Lead and Lag Exchanges -->
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label for="new-algo-lead-exchange" class="form-label">Lead Exchange</label>
                                                    <select class="form-select" id="new-algo-lead-exchange">
                                                        <option value="okx" selected>OKX</option>
                                                        <option value="htx">HTX</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="new-algo-lag-exchange" class="form-label">Lag Exchange</label>
                                                    <select class="form-select" id="new-algo-lag-exchange">
                                                        <option value="okx">OKX</option>
                                                        <option value="htx" selected>HTX</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <!-- Spread and Quantity -->
                                            <div class="row mt-3">
                                                <div class="col-md-6">
                                                    <label for="new-algo-spread" class="form-label">Spread</label>
                                                    <input type="number" step="0.01" class="form-control" id="new-algo-spread" placeholder="Enter Spread">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="new-algo-quantity" class="form-label">Quantity</label>
                                                    <input type="number" class="form-control" id="new-algo-quantity" placeholder="Enter Quantity">
                                                </div>
                                            </div>
                                            <!-- Instrument and Contract Type -->
                                            <div class="row mt-3">
                                                <div class="col-md-6">
                                                    <label for="new-algo-instrument" class="form-label">Instrument</label>
                                                    <select class="form-select" id="new-algo-instrument" onchange="updateCurrencyOptionsGeneral('new-algo-instrument','new-algo-ccy','new-algo-contract-type-container')">
                                                        <option value="swap" selected>SWAP</option>
                                                        <option value="futures">FUTURES</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="new-algo-ccy" class="form-label">Currency</label>
                                                    <select class="form-select" id="new-algo-ccy">
                                                        <option value="na"  disabled>Select a currency</option>
                                                        <option value="BTC-USD-SWAP" selected >BTC-USD</option>

                                                    </select>
                                                </div>
                                                <div class="col-md-6" id="new-algo-contract-type-container" style="display: none;">
                                                    <label for="new-algo-contract-type" class="form-label">Contract Type</label>
                                                    <select class="form-select" id="new-algo-contract-type">
                                                        <option value="thisweek" selected>This Week</option>
                                                        <option value="nextweek">Next Week</option>
                                                        <option value="quarter">Quarter</option>
                                                    </select>
                                                </div>
                                            </div>

                                            
                                            <div class="form-check form-switch mt-3">
                                                <input class="form-check-input" type="checkbox" id="new-algo-status" disabled>
                                                <label class="form-check-label" for="new-algo-status">Active</label>
                                            </div>
                                            
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" onclick="closeAlgoModal()">Cancel</button>
                                        <button type="button" class="btn btn-primary" onclick="saveAlgo()">Save</button>
                                    </div>

                                </div>
                            </div>
                        </div>

                        </div>

                    </div>
                </div>
            </div>
        </div>

            <!-- This section will be visible if the JWT is NOT present -->
            <div id="loginPrompt" class="alert alert-warning">
                <h4>You are not logged in.</h4>
                <p>Please log in to access secured content.</p>
            </div>

        </div>

         <!-- Order Management System Section -->
         <div id="securedContentOMS" class="alert alert-success" style="display: none;">
            <div class="card p-3">
                <h2 class="text-center">Order Management System (Prototype)</h2>

                <!-- Tabs -->
                <ul class="nav nav-tabs flex-wrap" id="omsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#assets-positions" type="button" role="tab">Assets & Positions</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#open-orders" type="button" role="tab">Open Orders</button>
                    </li>
                   
                </ul>
                <div class="tab-content mt-3">
                    <!-- Assets & Positions Tab -->
                    <div class="tab-pane fade show active" id="assets-positions" role="tabpanel">
                        
                        <p >
                            <button id="positions-refresh-btn" class="btn btn-primary btn-sm  mb-2" onclick="populatePositions()">Refresh</button>
                            
                            <tag class="text-end float-end text-muted">
                                Last updated: <span id="last-updated-positions">-</span>
                            </tag>
                        </p>
                       
                        <div class="table-responsive">
                           
                            <table class="OMStable table table-hover table-bordered table-sm">
                                <thead>
                                    <tr>
                                        <th>Exchange</th>
                                        <th>Instrument ID</th>
                                        <th>Lev</th>
                                        <th>Mgn Ratio</th>
                                        <th>Position (Buy/Sell)</th>
                                        <th>ADL</th>
                                        <th>Liquidation Price</th>
                                        <th>Price</th>
                                        <th>PnL</th>
                                        <th>Ts</th>
                                        <!-- <th colspan="2">Actions</th>  -->
                                    </tr>
                                </thead>
                                <tbody id="oms-open-positions-body">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Open Orders Tab -->
                    <div class="tab-pane fade" id="open-orders" role="tabpanel">
                       
                        <p>
                            <!-- First button (aligned left) -->
                            <button id="positions-refresh-btn" class="btn btn-primary btn-sm mb-2" onclick="populateOpenOrders()">Refresh</button>
                             <!-- Last updated (aligned right) -->
                             <tag class="text-end float-end text-muted">
                                Last updated: <span id="last-updated-orders">-</span>
                            </tag>
                            <!-- Second and third buttons (centered) -->
                            <!-- BUTTONS DANGEROUS -->
                            <div class="d-flex justify-content-center align-items-center mb-2">
                                <!-- Currency Selector -->
                                <select id="clearCurrencyDropdown" class="form-select form-select-sm mx-2" style="width: auto;">
                                    <option value="all" selected>All Currencies</option>
                                    <option value="BTC-USD-SWAP">BTC-USD-SWAP</option>
                                </select>
                                <!-- Lock/Unlock Button -->
                                <!-- Action Buttons -->
                                <button id="positions-clear-all-btn" class="btn btn-danger btn-sm mx-2" onclick="clearPositions('all')" disabled>Clear All</button>
                                <button id="positions-clear-okx-btn" class="btn btn-warning btn-sm mx-2" onclick="clearPositions('okx')" disabled>Clear OKX</button>
                                <button id="positions-clear-htx-btn" class="btn btn-warning btn-sm mx-2" onclick="clearPositions('htx')" disabled>Clear HTX</button>
                                <button id="lock-clear-btn" class="btn btn-secondary btn-sm mx-2" onclick="toggleLockClear()">üîí Unlock</button>
                            </div>
                           
                        </p>
                        
                        <div class="table-responsive" style="height: 400px; overflow-y: auto;">
                            <table class="OpenOrdersTable table table-hover table-bordered table-sm w-100">
                                <thead class="table-light" style="position: sticky; top: 0; z-index: 1020;">
                                    <tr>
                                        <th>Exchange</th>
                                        <th>Symbol</th>
                                        <th>Lev</th>
                                        <th>Side</th>
                                        <th>Fill|Order price</th>
                                        <th>Filled|Total</th>
                                        <th>TP|SL</th>
                                        <th>Order status|Number</th>
                                        <th>Order Time</th>
                                        <th>Action1</th>
                                        <th>Action2</th>
                                    </tr>
                                </thead>
                                <tbody id="oms-open-orders-body">
                                    <!-- Dynamic rows will be inserted here -->

                                </tbody>
                            </table>
                        </div>
                        
                    </div>

                </div>
                
            </div>
        </div>

        <!-- Placeholder Modal - will not be displayed. only displayed when button is pressed-->
        <div id="modifyPositionModal" class="modal" tabindex="-1" style="display: none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Modify Position</h5>
                        <button type="button" class="btn-close" onclick="closeModifyOrderModal()"></button>
                    </div>
                    <div class="modal-body">
                        <form id="modifyPositionForm">
                            <!-- Form fields will be dynamically added here -->
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModifyOrderModal()">Cancel</button>
                        <button type="submit" form="modifyPositionForm" class="btn btn-primary">Submit</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="./websocket_client/js/twiliocall.js"></script>
    <script src="./websocket_client/js/auth.js"></script>
    <script src="websocket_client/js/util.js"></script>
    <script src="https://cdn.socket.io/4.8.0/socket.io.min.js"></script>
    <script src="websocket_client/js/wsConnections.js"></script>
    <script src="websocket_client/js/display_last_trade.js"></script>
    <script src="websocket_client/js/display_orderbook.js"></script>
    <script src="websocket_client/js/display_position.js"></script>
    <script src="websocket_client/js/display_open_orders.js"></script>
    <script src="websocket_client/js/arbButton.js"></script>
    <script src="websocket_client/js/createAlgoOrders.js"></script>

    <!-- <script src="websocket_client/js/display_trade_history.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <script src="websocket_client/js/display_fundingrate.js"></script>

    <script>
        // Clear JWT token from localStorage when no longer needed
        function clearAuthToken() {
            localStorage.removeItem('jwt_token');
        }

        // Clear notifications when user logs out or navigates away
        function clearAllDataOnLogout() {
            clearAuthToken();
            clearNotifications();
        }

        // Remove event listener when no longer needed
        window.removeEventListener('beforeunload', () => {
            clearAuthToken();
            clearNotifications();
        });


        let currency_pair = null;
        
        function getAuthToken() {
            return localStorage.getItem('jwt_token');  // You can change this to sessionStorage if needed
        }
        

        // Check if the JWT token is present and display the corresponding content
        function checkJWTAndDisplay() {
            const token = getAuthToken();
            // Get the elements by ID
            const securedContent = document.getElementById('securedContent');
            const securedContentOMS = document.getElementById('securedContentOMS');
            const securedContentBidAskOrder = document.getElementById('securedContentBidAskOrder');

            // securedContentBidAskOrder
            const loginPrompt = document.getElementById('loginPrompt');

            if (token) {
                // If the token is present, show the secured content
                securedContent.style.display = 'block';
                securedContentOMS.style.display = 'block';
                securedContentBidAskOrder.style.display = 'block';

                loginPrompt.style.display = 'none';
            } else {
                // If the token is not present, show the login prompt
                securedContent.style.display = 'none';
                securedContentOMS.style.display = 'none';
                securedContentBidAskOrder.style.display = 'none';


                loginPrompt.style.display = 'block';
            }
        }

        // Run the function to check the JWT token and display appropriate content
        checkJWTAndDisplay();

        // Array to store notifications
        const notifications = [];
        
        function updateNotificationHub() {
            const toastList = document.getElementById('toast-list');

            toastList.innerHTML = ''; // Clear previous notifications
        
            let orderIdColor = 'bg-secondary'; // Grey by default
            let statusColor = 'bg-secondary'; // Grey by default
            let errColor = 'bg-secondary';   // Grey by default
            notifications.forEach(notification => {
                // if (notification.statusCode == 200) statusColor = 'bg-success';
                let orderIdColor = notification.orderId != null ? 'bg-success' : 'bg-danger';
                let statusColor = notification.statusCode == 200? 'bg-success' : 'bg-danger';
                let errColor = notification.errCode == null | notification.errCode =='undefined' ? 'bg-success' : 'bg-danger';


                const toastItem = document.createElement('div');
                toastItem.className = `toast-item toast-${notification.type}`;
                toastItem.innerHTML = `
                <div class="toast-item mb-2 p-3 rounded shadow text-start" style="background-color: #f9f9f9;">
                <div class="toast-header d-flex align-items-center">
                    <strong class="me-2">[${notification.apiSource}]</strong> 
                    <div class="ms-auto">
                        <span class="badge ${orderIdColor}">Order ID: ${notification.orderId}</span>
                        <span class="badge ms-1 ${statusColor}">Status: ${notification.statusCode}</span>
                        <span class="badge ms-1 ${errColor}">Error: ${notification.errCode}</span>
                    </div>
                </div>
                <div class="toast-body">
                    <p class="mb-1">${notification.message}</p>
                    <small class="text-muted">${notification.timestamp}</small>
                </div>
            </div>
                `;
                toastList.prepend(toastItem);
            });
        }

        // Toggle Notification Hub visibility
        function toggleNotificationHub() {
            const hub = document.getElementById('notification-hub');
            hub.style.display = hub.style.display === 'none' ? 'block' : 'none';
        }

        // Update notification count
        function updateNotificationCount() {
            const count = notifications.length;
            document.getElementById('notification-count').innerText = count;
        }

        // Clear all notifications
        function clearNotifications() {
            notifications.length = 0;
            updateNotificationHub();
            updateNotificationCount();
        }

        // Function to update the table for the selected currency
        function updateTableForCurrency(currency) {
            // console.log(currency_pair)
            
            document.querySelector('h4').innerText = `Order Book Comparison for ${currency}`;
            // TODO: Fetch new data and update order books dynamically here
            alert(`Order books updated for ${currency}`);
            currency_pair = currency
            // console.log(currency_pair)
        }


    $('.OMStable').DataTable({
        paging: true,
        searching: true,
        ordering: true,
        info: true,
        pageLength: 10,        // Default number of rows per page
        lengthMenu: [5, 10, 25, 50], // Dropdown menu for page length
        order: [[1, 'asc']],   // Default sorting (e.g., by Instrument ID)
        language: {
            search: "Filter records:", // Customize search input placeholder
            lengthMenu: "Display _MENU_ records per page"
        }
    });
    $('.OpenOrdersTable').DataTable({
        paging: true,
        searching: true,
        ordering: true,
        info: true,
        pageLength: 10,        // Default number of rows per page
        lengthMenu: [5, 10, 25, 50], // Dropdown menu for page length
        order: [[1, 'asc']],   // Default sorting (e.g., by Instrument ID)
        language: {
            search: "Filter records:", // Customize search input placeholder
            lengthMenu: "Display _MENU_ records per page"
        }
    });

    </script>

    <style>
        .form-control{
            font-size:small;
        }
        .algo-order-form-control{
            font-size: small;
            padding-left:5px;
            padding-right:5px;
            width:100%;
        }
    
        /* Custom Navbar Bottom Border */
        .navbar {
            border-bottom: 2px solid #ddd; /* Adjust color and thickness of the line */
        }

        .navbar-light .navbar-nav .nav-link {
            color: #007bff;
        }

        .navbar-light .navbar-nav .nav-link:hover {
            color: #0056b3;
        }

        /* Optional: Custom navbar spacing for better visual */
        .navbar-nav {
            margin-left: auto;
        }

        /* Make sure the parent container is a flex container */
        .orderbook-container {
            width:70%;
            display: flex;
            justify-content: space-between;  /* Ensure orderbooks are side by side */
            gap: 15px; /* Space between each orderbook */

        }

        /* Set a fixed width for each orderbook container */
        .scrollable-orderbook {
            max-height: 300px; /* Set a fixed height for uniformity */
            overflow-y: auto;  /* Enable vertical scrolling */
            border: 1px solid #ddd;  /* Optional border styling */
            /* padding: 10px; */
            background-color: #f9f9f9; /* Light background for better readability */
            display: flex;
            flex-direction: column;
            gap: 5px;  /* Add gap between asks and bids */
            box-sizing: border-box; /* Include padding and border in the element's total width */
            scroll-behavior: smooth;  /* Smooth scrolling for a better experience */
            scrollbar-width: thin; 
        }
        .scrollable-table {
            max-height: 550px; /* Set a fixed height for uniformity */
            overflow-y: auto;  /* Enable vertical scrolling */
            border: 1px solid #ddd;  /* Optional border styling */
            /* padding: 10px; */
            background-color: #f9f9f9; /* Light background for better readability */
            gap: 5px;  /* Add gap between asks and bids */
            scroll-behavior: smooth;  /* Smooth scrolling for a better experience */
            scrollbar-width: thin; 
        }

        .scrollable-lastprice {
            max-height: 300px; /* Set a fixed height for uniformity */
                overflow-y: auto;  /* Enable vertical scrolling */
                border: 1px solid #ddd;  /* Optional border styling */
                /* padding: 10px; */
                background-color: #f9f9f9; /* Light background for better readability */
                display: flex;
                flex-direction: column;
                gap: 5px;  /* Add gap between asks and bids */
                box-sizing: border-box; /* Include padding and border in the element's total width */
                scroll-behavior: smooth;  /* Smooth scrolling for a better experience */
                scrollbar-width: thin; 
            }


        /* Optional: Ensures each ask/bid has a consistent font size and line height */
        .scrollable-orderbook p,
        .scrollable-orderbook li {
            font-size: 15px;
            /* line-height: 1.6; */
            margin: 0;
            /* padding: 2px 0; */
        }

        .scrollable-orderbook ul  {
            list-style-type: none;
            padding-left: 0;
            margin: 0;
        }

        .scrollable-orderbook li  {
            margin-bottom: 5px;
        }
        /* Style for Asks (Red) */
        .scrollable-orderbook .asks ,.sell {
            color: red;
        }

        /* Style for Bids (Green) */
        .scrollable-orderbook .bids , .buy {
            color: green;
        }

        .run-button {
                color: #1db954; /* Spotify green */
                cursor: pointer;
                font-size: 1.5rem;
                transition: transform 0.2s ease;
            }
        .stop-button {
            color: #df0d0d; /* Spotify green */
            cursor: pointer;
            font-size: 1.5rem;
            transition: transform 0.2s ease;
        }
            

        .table-hover tbody tr:hover {
            background-color: #f9f9f9; /* Subtle hover effect */
        }

    </style>

</body>

</html>